{% extends 'partials/base.html.twig' %}
{% block content %}
    {% if akso_registration.disabled %}
    <div class="akso-registration-page">
        <h1>
            {{akso_registration.is_donation ? akso_locale.registration.title_donation : akso_locale.registration.title}}
        </h1>
        <div class="error-banner">
            {{akso_registration.disabled}}
        </div>
    </div>
    {% else %}
    {% if akso_registration.state.step >= 3 %}
    <div class="akso-registration-page">
    {% else %}
    <form class="akso-registration-page akso-form" method="POST">
    {% endif %}
        <h1>
            {{akso_registration.is_donation ? akso_locale.registration.title_donation : akso_locale.registration.title}}
        </h1>
        {% if akso_registration.state.form_error %}
            <div class="error-banner">
                {{akso_registration.state.form_error|raw}}
            </div>
        {% endif %}
        {% if akso_registration.state.payment_success %}
            <div class="message-banner">
                {{akso_locale.registration.payment_success_return_msg}}
            </div>
        {% endif %}
        <input
            class="hidden-input"
            type="hidden"
            name="state_serialized"
            value="{{ akso_registration.state.serialized|e('html_attr') }}" />
        {% if akso_registration.state.registered or akso_registration.state.step > 0 or akso_auth %}
        {% if akso_registration.state.step == 1 %}
        <button class="back-button" type="submit" formaction="{{akso_registration.targets.codeholder|e('html_attr')}}">
            <span class="back-icon"></span>
            {{akso_locale.registration.btn_back}}
        </button>
        {% elseif akso_registration.state.step == 2 %}
        <button class="back-button" type="submit" formaction="{{akso_registration.targets.offers|e('html_attr')}}">
            <span class="back-icon"></span>
            {{akso_locale.registration.btn_back}}
        </button>
        {% endif %}
        <div class="form-summary" role="group" aria-label="{{ akso_locale.registration.summary_title }}">
            <div class="codeholder-summary" role="group" aria-label="{{ akso_locale.registration.summary_codeholder }}">
                <div class="summary-codeholder-type">
                    {% if akso_registration.state.needs_login %}
                    {{akso_locale.registration.codeholder_login_to_view}}
                    {% elseif akso_auth %}
                    {{akso_locale.registration.codeholder_is_registered}}
                    {% elseif akso_registration.is_donation %}
                    {{akso_locale.registration.codeholder_is_new_donating}}
                    {% else %}
                    {{akso_locale.registration.codeholder_is_new}}
                    {% endif %}
                </div>
                {% if not akso_registration.state.needs_login %}
                    {% if akso_registration.is_donation %}
                        <div class="summary-name">
                            {# we are using the firstNameLegal field for the entire name in this mode #}
                            {{akso_registration.state.codeholder.firstNameLegal|e}}
                        </div>
                    {% else %}
                        <div class="summary-name">
                            {{akso_registration.state.codeholder.honorific|e}}
                            {% if akso_registration.state.codeholder.firstName %}
                            {{akso_registration.state.codeholder.firstName|e}}
                            {% else %}
                            {{akso_registration.state.codeholder.firstNameLegal|e}}
                            {% endif %}
                            {% if akso_registration.state.codeholder.lastName %}
                            {{akso_registration.state.codeholder.lastName|e}}
                            {% else %}
                            {{akso_registration.state.codeholder.lastNameLegal|e}}
                            {% endif %}
                            {% if akso_registration.state.codeholder.firstName or akso_registration.state.codeholder.lastName %}
                            ({{akso_locale.registration.codeholder_name_legal}}:
                            {{akso_registration.state.codeholder.firstNameLegal|e}}
                            {{akso_registration.state.codeholder.lastNameLegal|e}})
                            {% endif %}
                        </div>
                    {% endif %}
                    {% if not akso_registration.is_donation %}
                        <div class="summary-birthdate">
                            {{akso_locale.registration.codeholder_birthdate}}:
                            {{akso_registration.state.codeholder_derived.birthdate|e|default('—')}}
                        </div>
                    {% endif %}
                    <div class="summary-contact">
                        {{akso_registration.state.codeholder.email|e}}
                        {% if akso_registration.state.codeholder_derived.cellphone is not empty %}
                            · {{akso_locale.registration.codeholder_cellphone}}: {{akso_registration.state.codeholder_derived.cellphone|e}}
                        {% endif %}
                        {% if akso_registration.state.codeholder_derived.landline_phone is not empty %}
                            · {{akso_locale.registration.codeholder_landline_phone}}: {{akso_registration.state.codeholder_derived.landline_phone|e}}
                        {% endif %}
                    </div>
                    {% if not akso_registration.is_donation %}
                        <div class="summary-address">
                            {{akso_registration.state.codeholder_derived.address|e|default(akso_locale.registration.codeholder_no_address)}}
                        </div>
                        <div class="summary-payment">
                            {{akso_locale.registration.codeholder_summary_fee_country}}:
                            {{akso_registration.state.codeholder_derived.fee_country|e|default('—')}}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            {% if akso_registration.state.registered %}
            <div class="offers-summary" role="group" aria-label="{{ akso_locale.registration.summary_offers }}">
                {% for year, yearItems in akso_registration.state.offers %}
                <div class="offer-year">
                    {% set offerYear = akso_registration.offers_indexed[year] %}
                    <div class="year-label">{{year|e}}</div>
                    {% for offer in yearItems %}
                    <div class="offer-item">
                        {% if offer.type == 'membership' or offer.type == 'magazine' %}
                        <div class="item-inner">
                            <div class="item-name">
                                {% if offer.type == 'membership' %}
                                    <span class="item-abbrev">{{akso_registration.categories[offer.id].nameAbbrev|e}}</span>
                                    {{akso_registration.categories[offer.id].name|e}}
                                {% else %}
                                    {{akso_registration.magazines[offer.id].name|e}}
                                {% endif %}
                            </div>
                            <div class="item-price">
                                {{offer.amount_original_rendered|e}}
                            </div>
                        </div>
                        {% if offer.amount_addon > 0 %}
                        <div class="item-addon">
                            <div class="item-name">
                                {{akso_locale.registration.offers_price_addon_label}}
                            </div>
                            <div class="item-price">
                                {{offer.amount_addon_rendered|e}}
                            </div>
                        </div>
                        {% endif %}
                        {% elseif offer.type == 'addon' %}
                        <div class="item-inner">
                            <div class="item-name">
                                {{akso_registration.addons[offerYear.paymentOrgId][offer.id].name|e}}
                            </div>
                            <div class="item-price">
                                {{offer.amount_rendered|e}}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                <div class="price-sum">
                    <span class="sum-label">{{akso_locale.registration.offers_sum}}</span>
                    <span class="sum-value">{{akso_registration.state.offers_sum_rendered|e}}</span>
                </div>
            </div>
            {% elseif akso_registration.state.step > 1 %}
            <div class="offers-summary" role="group" aria-label="{{ akso_locale.registration.summary_offers }}">
                {% for year, yearItems in akso_registration.state.offers %}
                    <div class="offer-year">
                        {% set offerYear = akso_registration.offers_indexed[year] %}
                        <div class="year-label">{{offerYear.year|e}}</div>
                        {% for offerKey, offer in yearItems %}
                        {% set offerKeyParts = offerKey|split('-') %}
                        {% set groupIndex = offerKeyParts[0] %}
                        {% set offerIndex = offerKeyParts[1] %}
                        <div class="offer-item">
                            {% if offer.type == 'membership' or offer.type == 'magazine' %}
                            <div class="item-inner">
                                <div class="item-name">
                                    {% if offer.type == 'membership' %}
                                        <span class="item-abbrev">{{akso_registration.categories[offer.id].nameAbbrev|e}}</span>
                                        {{akso_registration.categories[offer.id].name|e}}
                                    {% else %}
                                        {{akso_registration.magazines[offer.id].name|e}}
                                        {% if offer.paper %}
                                            <span class="item-version">{{akso_locale.registration.offers_magazine_version_paper}}</span>
                                        {% else %}
                                            <span class="item-version">{{akso_locale.registration.offers_magazine_version_access}}</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="item-price">
                                    {{offer.amount_original_rendered|e}}
                                </div>
                            </div>
                            {% if offer.amount_addon > 0 %}
                            <div class="item-addon">
                                <div class="item-name">
                                    {{akso_locale.registration.offers_price_addon_label}}
                                </div>
                                <div class="item-price">
                                    {{offer.amount_addon_rendered|e}}
                                </div>
                            </div>
                            {% endif %}
                            {% elseif offer.type == 'addon' %}
                            <div class="item-inner">
                                <div class="item-name">
                                    {{akso_registration.addons[offerYear.paymentOrgId][offer.id].name|e}}
                                </div>
                                <div class="item-price">
                                    {{offer.amount_rendered|e}}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% endfor %}
                <div class="price-sum">
                    <span class="sum-label">{{akso_locale.registration.offers_sum}}</span>
                    <span class="sum-value">{{akso_registration.state.offers_sum_rendered}}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% if akso_registration.state.step == 0 %}
            {% if not akso_auth %}
            <div class="registration-notice logged-out-notice">
                <div class="notice-contents">{{akso_locale.registration.codeholder_logged_out_note}}</div>
                <div class="notice-buttons">
                    <a class="link-button is-primary" href="{{akso_login_path}}">
                        {{akso_locale.login.login_label}}
                    </a>
                </div>
            </div>
            {% endif %}
            {% set codeholder_is_valid = true %}
            {% if akso_auth %}
                {% if not akso_registration.state.codeholder.birthdate %}
                    {% set codeholder_is_valid = false %}
                {% endif %}
                {% if not akso_registration.state.codeholder.feeCountry %}
                    {% set codeholder_is_valid = false %}
                {% endif %}
                {% if not akso_registration.state.codeholder.address.country %}
                    {% set codeholder_is_valid = false %}
                {% endif %}
                {% if not codeholder_is_valid %}
                    <div class="registration-notice missing-data-notice">
                        <div class="notice-contents">{{akso_locale.registration.codeholder_missing_info_note}}</div>
                        <div class="notice-buttons">
                            <a class="link-button is-primary" href="{{akso_account_edit_path}}">
                                {{akso_locale.registration.codeholder_missing_info_go}}
                            </a>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
            {% if codeholder_is_valid %}
            <div class="registration-settings">
                {% if not akso_auth %}
                    {% if akso_registration.is_donation %}
                        <div class="settings-field" data-el="input" data-type="text">
                            <div class="inner-field">
                                <label for="codeholder-first-name-legal">
                                    {{akso_locale.registration.codeholder_full_name}}
                                    <span class="required-star" title="{{akso_locale.registration.required_field|e('html_attr')}}"> *</span>
                                </label>
                                <input
                                    id="codeholder-first-name-legal"
                                    name="codeholder[firstNameLegal]"
                                    type="text"
                                    value="{{akso_registration.state.codeholder.firstNameLegal|e('html_attr')}}" />
                            </div>
                        </div>
                        <div class="settings-field" data-el="input" data-type="email">
                            <div class="inner-field">
                                <label for="codeholder-email">
                                    {{akso_locale.registration.codeholder_email}}
                                    <span class="required-star" title="{{akso_locale.registration.required_field|e('html_attr')}}"> *</span>
                                </label>
                                <input
                                    id="codeholder-email"
                                    name="codeholder[email]"
                                    type="email"
                                    required
                                    value="{{akso_registration.state.codeholder.email|e('html_attr')}}" />
                            </div>
                        </div>
                    {% else %}
                    <div class="settings-section">
                        {{akso_locale.registration.codeholder_name}}
                    </div>
                    {% include 'partials/akso_user_profile_form.html.twig' %}
                    {% endif %}
                    <hr />
                {% endif %}
                <div class="settings-field">
                    <div class="inner-field">
                        <label for="registration-settings-currency">{{akso_locale.registration.settings_currency}}</label>
                        <select id="registration-settings-currency" name="currency">
                            {% for currency, multiplier in akso_registration.currencies %}
                                <option
                                    value="{{ currency|e('html_attr') }}"
                                    {% if akso_registration.state.currency == currency %}
                                    selected
                                    {% endif %}
                                    >{{akso_locale.currencies[currency]|e}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="field-description">
                        {{akso_locale.registration.settings_currency_desc}}
                    </div>
                </div>
            </div>
            <div class="form-terms">
                <input
                    id="tos-checkbox"
                    required
                    type="checkbox"
                    name="atos" />
                <label for="tos-checkbox">
                    {{ akso_registration.rendered_terms_label|raw }}
                </label>
            </div>
            <div class="form-buttons">
                <button type="submit" class="is-primary" formaction="{{akso_registration.targets.offers|e('html_attr')}}">
                    {{akso_registration.is_donation ? akso_locale.registration.codeholder_next_donation : akso_locale.registration.codeholder_next}}
                </button>
            </div>
            {% endif %}
        {% elseif akso_registration.state.step == 1 %}
            <div class="offer-selection">
                <h2>
                    {{akso_registration.is_donation ? akso_locale.registration.offers_title_donation : akso_locale.registration.offers_title}}
                </h2>
                <p>
                    {{akso_registration.is_donation ? akso_locale.registration.offers_desc_donation : akso_locale.registration.offers_desc}}
                </p>

                {% if akso_registration.offers is empty %}
                    <div class="offer-selection-empty">
                        {{akso_registration.is_donation ? akso_locale.registration.offers_desc_donation_empty : akso_locale.registration.offers_desc_empty}}
                    </div>
                {% endif %}

                {% for offerYear in akso_registration.offers %}
                <div class="offer-year" role="group" aria-label="{{akso_locale.registration.offers_year_title_0}}{{offerYear.year}}{{akso_locale.registration.offers_year_title_1}}">
                    <input class="year-expansion-switch" type="checkbox"
                        id="rx-year-{{offerYear.year|e}}"
                        aria-label="{{akso_locale.registration.offers_year_expand_toggle_0}}{{offerYear.year}}{{akso_locale.registration.offers_year_expand_toggle_1}}"
                        {% if offerYear.year == akso_registration.thisYear %}
                        checked
                        {% endif %} />

                    {% if not akso_registration.is_donation %}
                        <label tabindex="0" for="rx-year-{{offerYear.year|e}}" class="year-title" aria-hidden="true">
                            <span class="title-arrow"></span>
                            <span class="title-contents">
                                {{offerYear.year|e}}
                            </span>
                        </label>
                    {% endif %}

                    {% set hasMembershipItemForThisYear = false %}
                    {% for offerGroup in offerYear.offers %}
                        {% for offer in offerGroup.offers %}
                            {% if offer.type == 'membership' %}
                                {% set category = akso_registration.categories[offer.id] %}
                                {% if offer.is_duplicate and category.givesMembership %}
                                    {% set hasMembershipItemForThisYear = true %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if hasMembershipItemForThisYear %}
                        <div class="year-already-registered">
                            <div class="inner-description">
                                {{akso_locale.registration.offers_year_already_registered}}
                            </div>
                        </div>
                    {% endif %}

                    {% for groupIndex, offerGroup in offerYear.offers %}
                    <div class="year-offer-group" role="group" aria-label="{{offerGroup.title|e}}">
                        <div class="offer-group-info">
                            <div class="group-title">{{offerGroup.title|e}}</div>
                            <div class="group-description">{{offerGroup.description|raw}}</div>
                        </div>
                        {% for offerIndex, offer in offerGroup.offers %}
                        {% set id = 'offer-item-' ~ offerYear.year ~ '-' ~ groupIndex ~ '-' ~ offerIndex %}
                        {% set classes = '' %}
                        {# true if the offer is available to select #}
                        {% set available = true %}
                        {# true if the user already has the offer for this year #}
                        {% set duplicate = false %}
                        {% set is_mem_duplicate = false %}
                        {% if (offer.type == 'membership' or offer.type == 'magazine') and not offer.price %}
                            {% set available = false %}
                            {% set classes = classes ~ ' not-available' %}
                        {% endif %}
                        {% if offer.is_duplicate %}
                            {% set duplicate = true %}
                            {% set available = false %}
                            {% set classes = classes ~ ' not-available already-registered' %}
                        {% endif %}
                        {% if offer.type == 'membership' and not duplicate and akso_registration.categories[offer.id].givesMembership and hasMembershipItemForThisYear %}
                            {% set duplicate = true %}
                            {% set available = false %}
                            {% set classes = classes ~ ' not-available already-registered' %}
                            {% set is_mem_duplicate = true %}
                        {% endif %}

                        {% if available %}
                        {% set selectedOfferItem = akso_registration.state.offers_indexed[offerYear.year ~ '-' ~ groupIndex ~ '-' ~ offerIndex] %}
                        {% set offerItemName = '' %}
                        {% if offer.type == 'membership' %}
                            {% set offerItemName = akso_registration.categories[offer.id].name %}
                        {% elseif offer.type == 'magazine' %}
                            {% set offerItemName = akso_registration.magazines[offer.id].name %}
                        {% elseif offer.type == 'addon' %}
                            {% set offerItemName = akso_registration.addons[offerYear.paymentOrgId][offer.id].name %}
                        {% endif %}
                        <input
                            class="offer-item-selection"
                            aria-label="{{akso_locale.registration.offers_select_0}}{{offerItemName|e}}{{akso_locale.registration.offers_select_1}}"
                            {% if offer.type == 'membership' and akso_registration.categories[offer.id].givesMembership %}
                            type="radio"
                            name="offers[{{offerYear.year|e}}][membership]"
                            value="{{groupIndex}}-{{offerIndex}}-{{offer.type}}-{{offer.id}}"
                            {% else %}
                            type="checkbox"
                            {% set variant = '0' %}
                            {% if offer.paperVersion %}
                                {% set variant = 'p' %}
                            {% endif %}
                            name="offers[{{offerYear.year|e}}][{{groupIndex|e}}][{{offerIndex|e}}][{{offer.type}}-{{offer.id}}-{{variant}}]"
                            {% endif %}
                            {% if selectedOfferItem %}
                            checked
                            {% endif %}
                            id="{{id|e('html_attr')}}" />
                        {% endif %}
                        <div class="offer-item {{classes}}">
                            <div class="offer-item-inner">
                                <div class="item-selection">
                                    {% if duplicate %}
                                        {% if is_mem_duplicate %}
                                            <span class="selection-box is-already-registered-with-other"></span>
                                        {% else %}
                                            <span class="selection-box is-already-registered"></span>
                                        {% endif %}
                                    {% else %}
                                    <label tabindex="0" aria-hidden="true" class="selection-box" for="{{id|e('html_attr')}}"></label>
                                    {% endif %}
                                </div>
                                {% if offer.type == 'membership' or offer.type == 'magazine' %}
                                <div class="item-details">
                                    <div class="item-name">
                                        {% if offer.type == 'membership' %}
                                            <span class="item-abbrev">{{akso_registration.categories[offer.id].nameAbbrev|e}}</span>
                                            {{akso_registration.categories[offer.id].name|e}}
                                        {% else %}
                                            {{akso_registration.magazines[offer.id].name|e}}
                                            {% if offer.paperVersion %}
                                                <span class="item-version">{{akso_locale.registration.offers_magazine_version_paper}}</span>
                                            {% else %}
                                                <span class="item-version">{{akso_locale.registration.offers_magazine_version_access}}</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="item-description">
                                        {{akso_registration.categories[offer.id].description|raw}}
                                    </div>
                                </div>
                                {% if not duplicate %}
                                <div class="item-price">
                                    {% if offer.price %}
                                        {{offer.price.amount|e}}
                                    {% else %}
                                        {{akso_locale.registration.offer_not_available}}
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% elseif offer.type == 'addon' %}
                                <div class="item-details">
                                    <div class="item-name">
                                        {{akso_registration.addons[offerYear.paymentOrgId][offer.id].name|e}}
                                    </div>
                                    <div class="item-description">
                                        {{akso_registration.addons[offerYear.paymentOrgId][offer.id].description|raw}}
                                    </div>
                                </div>
                                <div class="item-price is-variable">
                                    <input
                                        class="price-input"
                                        name="offer_amount[{{offerYear.year|e}}-{{groupIndex}}-{{offerIndex}}]"
                                        value="{{akso_registration.state.offers_indexed_amounts[offerYear.year ~ '-' ~ groupIndex ~ '-' ~ offerIndex]|e('html_attr')}}"
                                        type="text"
                                        placeholder="{{akso_registration.state.currency_placeholder}}"
                                        inputmode="numeric" />
                                    <span class="price-currency">
                                        {{akso_registration.state.currency}}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                            {% if (offer.type == 'membership' or offer.type == 'magazine') and offer.price and offer.price.description and not duplicate %}
                            <div class="item-price-description">
                                <div class="inner-padding"></div>
                                <div class="inner-description">
                                    <div class="inner-title">{{akso_locale.registration.offer_price_desc_title}}</div>
                                    {{offer.price.description|raw}}
                                </div>
                            </div>
                            {% endif %}
                            {% if (offer.type == 'membership' or offer.type == 'magazine') and offer.price %}
                            <div class="item-price-addon">
                                <input
                                    class="price-addon-checkbox"
                                    id="{{id|e('html_attr')}}-var-price"
                                    {% if selectedOfferItem and selectedOfferItem.amount_addon > 0 %}
                                    checked
                                    {% endif %}
                                    type="checkbox" />
                                <label class="price-addon-checkbox-label" for="{{id|e('html_attr')}}-var-price">
                                    {{akso_locale.registration.offers_use_price_addon}}
                                </label>
                                <div class="price-addon-description">
                                    {{akso_locale.registration.offers_use_price_addon_desc}}
                                </div>
                                <div class="price-addon-inner">
                                    <label class="price-addon-inner-label">
                                        {{akso_locale.registration.offers_price_addon_label}}
                                    </label>
                                    <input
                                        class="price-input"
                                        name="offer_amount_addon[{{offerYear.year|e}}-{{groupIndex}}-{{offerIndex}}]"
                                        value="{{akso_registration.state.offers_indexed_amount_addons[offerYear.year ~ '-' ~ groupIndex ~ '-' ~ offerIndex]|e('html_attr')}}"
                                        type="text"
                                        placeholder="{{akso_registration.state.currency_placeholder}}"
                                        inputmode="numeric" />
                                    <span class="price-currency">
                                        {{akso_registration.state.currency}}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            <div class="form-buttons">
                {% if akso_registration.offers is not empty %}
                <button type="submit" class="is-primary" formaction="{{akso_registration.targets.summary|e('html_attr')}}">
                    {{akso_locale.registration.offers_next}}
                </button>
                {% endif %}
            </div>
        {% elseif akso_registration.state.step == 2 %}
        <p>
            {{akso_registration.is_donation ? akso_locale.registration.entry_create_desc_donation : akso_locale.registration.entry_create_desc}}
        </p>
        <div class="form-buttons">
            <button type="submit" class="is-primary" formaction="{{akso_registration.targets.entry_create|e('html_attr')}}">
                {{akso_registration.is_donation ? akso_locale.registration.entry_create_donation : akso_locale.registration.entry_create}}
            </button>
        </div>
        {% elseif akso_registration.state.step == 3 %}
        <div class="payment-orgs">
            {% for org in akso_registration.payment_orgs %}
            {% set po_title = '' %}
            {% if count(org.years) > 1 %}
                {% set po_title = akso_locale.registration.payment_org_for_years %}
            {% else %}
                {% set po_title = akso_locale.registration.payment_org_for_year %}
            {% endif %}
            {% for i, year in org.years %}
                {% if i > 0 %}
                    {% set po_title = po_title ~ ',' %}
                {% endif %}
                {% set po_title = po_title ~ ' ' ~ year %}
            {% endfor %}
            <div class="payment-org" role="group" aria-label="{{po_title|e}}">
                <div class="org-title">
                    <div class="title-inner">
                        {{po_title|e}}
                    </div>
                    {% if org.can_pay %}
                    <div class="title-price">
                        {{org.offers_sum_rendered}}
                    </div>
                    {% endif %}
                </div>

                {# collect all payments for this org #}
                {% set org_payments = [] %}
                {% set has_payments = false %}
                {% for year in org.years %}
                    {% for payment in akso_registration.state.year_payments[year] %}
                        {% set org_payments = org_payments|merge({ (payment.idEncoded): payment }) %}
                        {% set has_payments = true %}
                    {% endfor %}
                {% endfor %}

                {% if has_payments %}
                    <div class="org-payment-history">
                        {% set aksopay_intent_base = akso_registration.aksopay_intent_base %}
                        <h3>{{ akso_locale.registration.payment_history_title }}</h3>
                        {% for payment in org_payments %}
                            {% set data_id = payment.specificPurposeDataId %}
                            {% include 'partials/akso_pending_payment.html.twig' %}
                        {% endfor %}
                    </div>
                {% endif %}

                {% if org.can_pay %}
                    {% if has_payments %}
                        <details>
                            <summary>
                                {{ akso_locale.registration.payment_org_methods_when_pending }}
                            </summary>
                        <p>
                            {{ akso_locale.registration.payment_org_methods_when_pending_desc }}
                        </p>
                    {% endif %}
                        <ul class="org-methods">
                            {% if count(org.methods) == 0 %}
                                <li class="methods-empty">{{akso_locale.registration.payment_org_no_methods}}</li>
                            {% endif %}
                            {% for method in org.methods %}
                            {% if method.isRecommended %}
                            <li class="payment-method is-recommended">
                            {% else %}
                            <li class="payment-method">
                            {% endif %}
                                {% set method_radio_id = 'payment-method-check-' ~ org.id ~ '-' ~ method.id %}
                                {% if method.thumbnail_src %}
                                    <div class="method-thumbnail">
                                        <img
                                            class="method-thumbnail-image"
                                            loading="lazy"
                                            alt="{{ method.name|e('html_attr') }}"
                                            src="{{ method.thumbnail_src|e('html_attr') }}"
                                            srcset="{{ method.thumbnail_srcset|e('html_attr') }}" />
                                    </div>
                                {% endif %}
                                <div class="method-details">
                                    <label class="method-name" for="{{method_radio_id}}">{{method.name|e}}</label>
                                    <div class="method-description">
                                        {{method.description|raw}}
                                    </div>
                                    {% if method.type == 'intermediary' and method.available %}
                                        <div class="method-intermediary">
                                            <div class="intermediary-title">
                                                {{akso_locale.registration.payment_method_intermediary_title}}
                                            </div>
                                            <p class="intermediary-desc">
                                                {{akso_locale.registration.payment_method_intermediary_desc}}
                                            </p>
                                            {% for offer in akso_registration.state.offers[method.year] %}
                                                <div class="intermediary-offer">
                                                    <div class="item-name">
                                                        {% if offer.type == 'membership' %}
                                                            <span class="item-abbrev">{{akso_registration.categories[offer.id].nameAbbrev|e}}</span>
                                                            {{akso_registration.categories[offer.id].name|e}}
                                                        {% else %}
                                                            {{akso_registration.magazines[offer.id].name|e}}
                                                            {% if offer.paper %}
                                                                <span class="item-version">{{akso_locale.registration.offers_magazine_version_paper}}</span>
                                                            {% else %}
                                                                <span class="item-version">{{akso_locale.registration.offers_magazine_version_access}}</span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                    <div class="item-price">
                                                        {% set offerId = offer.type ~ '-' ~ offer.id %}
                                                        {{method.offers[offerId].amount|e}}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            <div class="intermediary-offer is-total">
                                                <div class="item-name">
                                                    {{akso_locale.registration.payment_method_intermediary_total}}
                                                </div>
                                                <div class="item-price">
                                                    {{method.offers_sum_rendered|e}}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if method.fee_total %}
                                    <div class="method-fees">
                                        <div class="item-name">{{akso_locale.registration.payment_method_fees}}</div>
                                        <div class="item-price">{{method.fee_total_rendered|e}}</div>
                                    </div>
                                    {% endif %}
                                    {% if method.type == 'intermediary' and not method.available %}
                                        <div class="method-error">
                                            {{method.error}}
                                        </div>
                                    {% endif %}
                                    {% if method.type == 'intermediary' %}
                                        {% for intermediary in method.intermediaries %}
                                            <div class="method-intermediary-info">
                                                <div class="payment-desc-title">
                                                    {{akso_locale.registration.payment_method_intermediary_info_0}}
                                                    {{akso_registration.state.codeholder_derived.fee_country|e|default('—')}}
                                                    {{akso_locale.registration.payment_method_intermediary_info_1}}
                                                </div>
                                                <div class="payment-desc">
                                                    {{intermediary.desc_rendered|raw|default(akso_locale.registration.payment_method_intermediary_no_desc)}}
                                                </div>
                                                <ul class="codeholder-card-container codeholder-list">
                                                    {{intermediary.codeholder_rendered|raw}}
                                                </ul>
                                                <form
                                                    method="POST"
                                                    {% if method.above_max_amount %}
                                                    data-is-not-available
                                                    {% endif %}
                                                    class="method-selection">
                                                    <input type="hidden" name="payment_org" value="{{ org.id }}" />
                                                    <input type="hidden" name="payment_method_id" value="{{ method.id }}" />
                                                    <input type="hidden" name="intermediary_codeholder" value="{{ intermediary.codeholderId }}" />
                                                    <div class="method-selection-price">
                                                        {{method.total_sum_rendered}}
                                                    </div>
                                                    <div class="submit-container">
                                                        {% if method.available %}
                                                            <button type="submit">
                                                                {{akso_locale.registration.payment_method_intermediary_select}}
                                                            </button>
                                                        {% elseif method.above_max_amount %}
                                                            <div class="method-above-max-amount">
                                                                {{akso_locale.registration.payment_method_maxamount_unavailable}}
                                                            </div>
                                                        {% else %}
                                                            {{akso_locale.registration.payment_method_intermediary_unavailable}}
                                                        {% endif %}
                                                    </div>
                                                </form>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <form
                                            method="POST"
                                            {% if method.above_max_amount %}
                                            data-is-not-available
                                            {% endif %}
                                            class="method-selection">
                                            <div class="method-selection-price">
                                                {{method.total_sum_rendered}}
                                            </div>
                                            <input type="hidden" name="payment_org" value="{{org.id}}" />
                                            <input type="hidden" name="payment_method_id" value="{{method.id}}" />
                                            <div class="submit-container">
                                                {% if method.above_max_amount %}
                                                    <div class="method-above-max-amount">
                                                        {{akso_locale.registration.payment_method_maxamount_unavailable}}
                                                    </div>
                                                {% else %}
                                                    <button type="submit">
                                                        {{akso_locale.registration.payment_method_select}}
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </form>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                            {% if org.methods_currency_unavailable > 0 %}
                                <li class="methods-empty">{{akso_locale.registration.payment_org_methods_currency_unavailable}}</li>
                            {% endif %}
                        </ul>
                    {% if has_payments %}
                        </details>
                    {% endif %}
                {% else %}
                    <ul class="org-summary">
                        {% for year in org.years %}
                            <li class="org-year-state">
                                <span class="year-title">{{year|e}}</span>
                                <span class="year-status">
                                    {{akso_locale.registration['payment_status_' ~ akso_registration.state.year_statuses[year]]}}
                                </span>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% if akso_registration.state.step >= 3 %}
    </div>
    {% else %}
    </form>
    {% endif %}
    {% endif %}
{% endblock %}
