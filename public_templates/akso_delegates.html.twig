{% extends 'partials/base.html.twig' %}
{% block content %}
    {{page.content}}

    <ul class="delegates-filter-picker" role="radiogroup" aria-label="{{akso_locale.delegates.view_mode_label}}">
        {% set selected = akso_delegates.common.view_mode == 'country' %}
        <li class="picker-item{{selected ? ' selected' : ''}}">
            <a href="{{akso_delegates.common.view_mode_links.country}}" role="radio" aria-checked="{{selected ? 'true' : 'false'}}">
                {{akso_locale.delegates.view_mode_country}}
            </a>
        </li>
        {% set selected = akso_delegates.common.view_mode == 'subject' %}
        <li class="picker-item{{selected ? ' selected' : ''}}">
            <a href="{{akso_delegates.common.view_mode_links.subject}}" role="radio" aria-checked="{{selected ? 'true' : 'false'}}">
                {{akso_locale.delegates.view_mode_subject}}
            </a>
        </li>
        {% set selected = akso_delegates.common.view_mode == 'codeholder' %}
        <li class="picker-item{{selected ? ' selected' : ''}}">
            <a href="{{akso_delegates.common.view_mode_links.codeholder}}" role="radio" aria-checked="{{selected ? 'true' : 'false'}}">
                {{akso_locale.delegates.view_mode_codeholder}}
            </a>
        </li>
    </ul>

    {% if akso_delegates.common.view_mode == 'country' %}
        {% set should_collapse = '' %}
        {% if akso_delegates.view_mode == 'country' %}
            {% set should_collapse = 'init-collapsed' %}
        {% endif %}
        {% set country_selector = {
            should_collapse: should_collapse,
            view: akso_delegates.view,
            list_country_codes: akso_delegates.list_country_codes,
            list_country_links: akso_delegates.list_country_links,
            country_names: akso_delegates.country_names,
            country_emoji: akso_delegates.country_emoji,
        } %}
        {% include 'partials/akso_country_selector.html.twig' %}
    {% elseif akso_delegates.common.view_mode == 'subject' %}
        <form class="delegate-subject-search-form inline-search-form" action="{{akso_delegates.form_target}}">
            <input type="hidden" name="fako" value="*">
            <input
                class="search-query"
                type="text"
                name="q"
                placeholder="{{akso_locale.delegates.subject_search_placeholder}}"
                value="{{akso_delegates.search_query}}" />
            <button type="submit" class="search-submit">
                <img
                    class="search-icon"
                    role="presentation"
                    aria-label="{{akso_locale.delegate.subject_search_label}}"
                    src="/user/themes/uea/images/search.svg" />
            </button>
        </form>
    {% elseif akso_delegates.common.view_mode == 'codeholder' %}
        <form class="delegate-search-form inline-search-form" action="{{akso_delegates.form_target}}">
            <input
                class="search-query"
                type="text"
                name="nomo"
                placeholder="{{akso_locale.delegates.codeholder_search_placeholder}}"
                value="{{akso_delegates.search_query}}" />
            <button type="submit" class="search-submit">
                <img
                    class="search-icon"
                    role="presentation"
                    aria-label="{{akso_locale.delegate.codeholder_search_label}}"
                    src="/user/themes/uea/images/search.svg" />
            </button>
        </form>
    {% endif %}

    <div class="delegates-additional-filters">
        FIXME this needs to be in a form somehow
        <div class="hosting-filter">
            <input id="hosting-filter-enable" type="checkbox">
            <label for="hosting-filter-enable">{{akso_locale.delegates.filter_hosting_label}}</label>
        </div>
    </div>

    {% macro delegate_item(akso_locale, akso_delegates, delegation) %}
        {% set codeholder = akso_delegates.codeholders[delegation.codeholderId] %}
        <li class="delegate-item" data-has-picture="{{ codeholder.profilePictureHash ? 'true' : 'false' }}">
            {% if delegation.hosting and (delegation.hosting.maxDays or delegation.hosting.maxPersons) %}
                <div class="delegate-hosting-stub">
                    {{akso_locale.delegates.delegate_offers_hosting}}
                </div>
            {% endif %}
            {% if codeholder.profilePictureHash %}
            <div class="delegate-picture">
                <img
                    src="{{codeholder.icon_src|e('html_attr')}}"
                    srcset="{{codeholder.icon_srcset|e('html_attr')}}">
            </div>
            {% endif %}
            <h3 class="delegate-name">
                {{codeholder.fmt_name}}
            </h3>
            <div class="delegate-subjects-title">
                {{akso_locale.delegates.delegate_subjects_title}}
            </div>
            <ul class="delegate-subjects">
            {% for subjectId in delegation.subjects %}
                {% set subject = akso_delegates.subjects[subjectId] %}
                <li class="subject-item">
                    <div class="subject-name">
                        <a href="{{akso_delegates.common.filter_subject_link}}{{subjectId}}">
                            {{subject.name}}
                        </a>
                    </div>
                    <div class="subject-description">
                        {{subject.description}}
                    </div>
                </li>
            {% endfor %}
            </ul>
        </li>
    {% endmacro %}

    {% if akso_delegates.view_mode == 'country' %}
        {% set code = akso_delegates.view %}
        <h1 class="country-title">
            <img
                class="inline-flag-icon"
                draggable="false"
                src="{{akso_delegates.country_emoji[code].src|e('html_attr')}}"
                alt="{{akso_delegates.country_emoji[code].alt|e('html_attr')}}" />
            {{akso_delegates.country_names[code]}}
        </h1>

        <ul class="country-levels">
            {% for level, level_delegates in akso_delegates.delegates_by_level %}
                <li class="country-level" data-level="{{level}}">
                    <div class="level-info">
                        <h2 class="level-label">
                            {{akso_locale.delegates['country_level_' ~ level]}}
                        </h2>
                    </div>
                    <ul class="level-delegates">
                        {% for delegation in level_delegates %}
                            {{_self.delegate_item(akso_locale, akso_delegates, delegation)}}
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
        <ul class="delegation-cities">
            {% for city in akso_delegates.cities %}
                {% set city_delegates = akso_delegates.delegates_by_city[city.id] %}
                <li class="delegation-city" data-geo-id="{{city.id}}" data-label="{{city.label}}">
                    <div class="city-info">
                        <h2 class="city-label">{{city.label}}</h2>
                        <div class="city-meta">
                            <div class="city-subdivision">{{city.subdivision}}</div>
                            <div class="city-population">
                                {{akso_locale.delegates.population_0}}
                                {{city.population}}
                                {{akso_locale.delegates.population_1}}
                            </div>
                        </div>
                    </div>
                    <ul class="city-delegates">
                        {% for delegation in city_delegates %}
                            {{_self.delegate_item(akso_locale, akso_delegates, delegation)}}
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if akso_delegates.common.view_mode == 'codeholder' or akso_delegates.common.view_mode == 'subject' %}
        <ul class="delegate-list">
            {% for delegation in akso_delegates.delegations %}
                {{_self.delegate_item(akso_locale, akso_delegates, delegation)}}
            {% endfor %}
        </ul>
    {% endif %}

    {% if akso_delegates.should_paginate %}
        {% if akso_delegates.page == 1 %}
            <a class="link-button" href="{{akso_delegates.page_link_first}}#landoj">
                {{akso_locale.delegates.prev_page}}
            </a>
        {% elseif akso_delegates.page > 0 %}
            {# page is zero indexed but pages are one-indexed #}
            <a class="link-button" href="{{akso_delegates.page_link_stub}}{{akso_delegates.page}}#landoj">
                {{akso_locale.delegates.prev_page}}
            </a>
        {% endif %}
        {% if akso_delegates.page < akso_delegates.max_page %}
            <a class="link-button" href="{{akso_delegates.page_link_stub}}{{akso_delegates.page + 2}}#landoj">
                {{akso_locale.delegates.next_page}}
            </a>
        {% endif %}
    {% endif %}
{% endblock %}
